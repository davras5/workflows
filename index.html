<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoDataCheck - BBL</title>
    <style>
        :root {
            --primary: #1E3A5F;
            --primary-light: #2d4a6f;
            --error: #E3000F;
            --error-light: #fee2e2;
            --warning: #F57C00;
            --warning-light: #fff3e0;
            --success: #2E7D32;
            --success-light: #e8f5e9;
            --info: #1976D2;
            --bg: #F5F5F5;
            --surface: #FFFFFF;
            --text: #212121;
            --text-secondary: #757575;
            --border: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        header .subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* Main container */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        /* Checker Gallery */
        .checker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .checker-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checker-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .checker-card .category {
            font-size: 0.75rem;
            color: var(--warning);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .checker-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .checker-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .checker-card .required {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .checker-card .btn-start {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .checker-card .btn-start:hover {
            background: var(--primary-light);
        }

        /* Upload area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: #f0f4f8;
        }

        .upload-area .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        /* Privacy notice */
        .privacy-notice {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--success);
            margin-top: 1rem;
            justify-content: center;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
        }

        /* Column mapping grid */
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-card.error .value { color: var(--error); }
        .stat-card.warning .value { color: var(--warning); }
        .stat-card.success .value { color: var(--success); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-radius: 4px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: var(--bg);
        }

        /* Dimension cards */
        .dimension-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .dimension-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .dimension-card h4 {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .dimension-card .count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .dimension-card .errors {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .dimension-card .error-badge {
            color: var(--error);
        }

        .dimension-card .warning-badge {
            color: var(--warning);
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        /* Error table */
        .error-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .error-table th, .error-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .error-table th {
            background: var(--bg);
            font-weight: 600;
        }

        .error-table tr:hover {
            background: #f8f9fa;
        }

        .severity-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .severity-badge.error {
            background: var(--error-light);
            color: var(--error);
        }

        .severity-badge.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .severity-badge.info {
            background: #e3f2fd;
            color: var(--info);
        }

        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .back-btn:hover {
            color: var(--text);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Session timer */
        .session-timer {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Download buttons */
        .download-section {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>GeoDataCheck</h1>
            <div class="subtitle">BBL - Bundesamt f√ºr Bauten und Logistik</div>
        </div>
        <div class="session-timer" id="sessionTimer" style="display: none;">
            ‚è±Ô∏è Session: <span id="timerDisplay">30:00</span>
        </div>
    </header>

    <main>
        <!-- View 1: Checker Gallery -->
        <div id="galleryView" class="view active">
            <div class="card">
                <h2>Verf√ºgbare Checker</h2>
                <div class="checker-grid" id="checkerGrid">
                    <!-- Filled by JS -->
                </div>
            </div>

            <div class="privacy-notice">
                üîí Ihre Daten werden lokal verarbeitet und niemals gespeichert
            </div>
        </div>

        <!-- View 2: Upload & Configure -->
        <div id="uploadView" class="view">
            <a class="back-btn" onclick="showView('gallery')">‚Üê Zur√ºck zur √úbersicht</a>

            <div class="card">
                <div id="checkerInfo">
                    <span class="checker-card category" id="selectedCategory">QUALIT√ÑTSSICHERUNG</span>
                    <h2 id="selectedCheckerName">Adress-Checker</h2>
                    <p id="selectedCheckerDesc">Pr√ºft Schweizer Adressen auf Format, PLZ-Format und Kantone.</p>
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border);">

                <div class="upload-area" id="uploadArea">
                    <div class="icon">üìÅ</div>
                    <div><strong>Datei hier ablegen</strong></div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">oder klicken zum Ausw√§hlen</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Unterst√ºtzt: .xlsx, .xls</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                </div>

                <div id="fileInfo" style="display: none; margin-top: 1rem;">
                    <p>üìÑ <strong id="fileName"></strong> - <span id="rowCount"></span> Zeilen</p>
                </div>
            </div>

            <!-- Column Mapping -->
            <div class="card" id="mappingCard" style="display: none;">
                <h2>Spaltenzuordnung</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    √úberpr√ºfen Sie die automatisch erkannten Spalten oder passen Sie die Zuordnung an.
                </p>

                <div class="mapping-grid" id="mappingGrid">
                    <!-- Filled by JS -->
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border);">

                <h3 style="font-size: 1rem; margin-bottom: 1rem;">Gruppierung f√ºr Dashboard</h3>
                <div class="mapping-grid">
                    <div class="form-group">
                        <label>Region / Kanton</label>
                        <select id="dimRegion"><option value="">-- Nicht verwenden --</option></select>
                    </div>
                    <div class="form-group">
                        <label>Portfolio-Typ</label>
                        <select id="dimPortfolio"><option value="">-- Nicht verwenden --</option></select>
                    </div>
                    <div class="form-group">
                        <label>Zust√§ndige Person</label>
                        <select id="dimResponsible"><option value="">-- Nicht verwenden --</option></select>
                    </div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" id="validateBtn" onclick="runValidation()">
                        Validierung starten
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div class="card" id="loadingCard" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
                <p style="text-align: center; color: var(--text-secondary);">Validierung l√§uft...</p>
            </div>
        </div>

        <!-- View 3: Results Dashboard -->
        <div id="resultsView" class="view">
            <a class="back-btn" onclick="showView('gallery')">‚Üê Neuer Check</a>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value" id="statTotal">0</div>
                    <div class="label">Total Zeilen</div>
                </div>
                <div class="stat-card error">
                    <div class="value" id="statErrors">0</div>
                    <div class="label">Fehler</div>
                </div>
                <div class="stat-card warning">
                    <div class="value" id="statWarnings">0</div>
                    <div class="label">Warnungen</div>
                </div>
                <div class="stat-card success">
                    <div class="value" id="statPassed">0</div>
                    <div class="label">Bestanden</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">√úbersicht</button>
                <button class="tab-btn" data-tab="region" onclick="switchTab('region')">Nach Region</button>
                <button class="tab-btn" data-tab="portfolio" onclick="switchTab('portfolio')">Nach Portfolio</button>
                <button class="tab-btn" data-tab="responsible" onclick="switchTab('responsible')">Nach Zust√§ndig</button>
                <button class="tab-btn" data-tab="details" onclick="switchTab('details')">Alle Fehler</button>
            </div>

            <!-- Tab: Overview -->
            <div id="tab-overview" class="tab-content">
                <div class="card">
                    <h2>Fehler nach Kategorie</h2>
                    <div class="dimension-grid" id="categoryGrid">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="card">
                    <h2>Top Probleme</h2>
                    <div id="topIssues">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- Tab: Region -->
            <div id="tab-region" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>Nach Region</h2>
                    <div class="dimension-grid" id="regionGrid">
                        <p style="color: var(--text-secondary);">Keine Region-Spalte ausgew√§hlt</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Portfolio -->
            <div id="tab-portfolio" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>Nach Portfolio-Typ</h2>
                    <div class="dimension-grid" id="portfolioGrid">
                        <p style="color: var(--text-secondary);">Keine Portfolio-Spalte ausgew√§hlt</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Responsible -->
            <div id="tab-responsible" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>Nach zust√§ndiger Person</h2>
                    <div class="dimension-grid" id="responsibleGrid">
                        <p style="color: var(--text-secondary);">Keine Zust√§ndig-Spalte ausgew√§hlt</p>
                    </div>
                </div>
            </div>

            <!-- Tab: All Errors -->
            <div id="tab-details" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>Alle Fehler und Warnungen</h2>
                    <div style="overflow-x: auto;">
                        <table class="error-table">
                            <thead>
                                <tr>
                                    <th>Zeile</th>
                                    <th>Spalte</th>
                                    <th>Regel</th>
                                    <th>Schweregrad</th>
                                    <th>Meldung</th>
                                </tr>
                            </thead>
                            <tbody id="errorTableBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Download -->
            <div class="card">
                <h2>üì• Download</h2>
                <div class="download-section">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        Fehlerbericht herunterladen (Excel)
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        BBL ¬∑ Bundesamt f√ºr Bauten und Logistik ¬∑ GeoDataCheck v1.0
    </footer>

    <script>
        // API base URL - auto-detects environment
        // Local: http://localhost:8000
        // Production: https://app-white-dew-8499.fly.dev
        const API_URL = window.location.hostname === 'localhost'
            || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : 'https://app-white-dew-8499.fly.dev';

        // State
        let state = {
            sessionId: null,
            selectedChecker: null,
            columns: [],
            detectedMappings: {},
            results: null,
            sessionExpiry: null,
        };

        // ====================================================================
        // Initialization
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            loadCheckers();
            setupFileUpload();
        });

        async function loadCheckers() {
            try {
                const response = await fetch(`${API_URL}/api/checkers`);
                const data = await response.json();
                renderCheckers(data.checkers);
            } catch (error) {
                console.error('Error loading checkers:', error);
                document.getElementById('checkerGrid').innerHTML = `
                    <p style="color: var(--error);">Fehler beim Laden der Checker. Ist der Server gestartet?</p>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                        Starten Sie den Server mit: <code>uvicorn main:app --reload</code>
                    </p>
                `;
            }
        }

        function renderCheckers(checkers) {
            const grid = document.getElementById('checkerGrid');
            grid.innerHTML = checkers.map(checker => `
                <div class="checker-card" onclick="selectChecker('${checker.id}')">
                    <div class="category">${checker.category}</div>
                    <h3>${checker.name}</h3>
                    <p>${checker.description}</p>
                    ${checker.required_columns.length > 0 ? `
                        <div class="required">
                            ‚òê Erfordert: ${checker.required_columns.join(', ')}
                        </div>
                    ` : ''}
                    <button class="btn-start">
                        Checker starten <span>‚Üí</span>
                    </button>
                </div>
            `).join('');
        }

        // ====================================================================
        // File Upload
        // ====================================================================

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        async function handleFile(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('Bitte laden Sie eine Excel-Datei hoch (.xlsx oder .xls)');
                return;
            }

            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').style.display = 'block';

            // Upload file
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/api/upload`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const data = await response.json();

                state.sessionId = data.session_id;
                state.columns = data.columns;
                state.detectedMappings = data.detected_mappings;

                document.getElementById('rowCount').textContent = data.row_count;

                // Start session timer
                state.sessionExpiry = Date.now() + (data.expires_in_minutes * 60 * 1000);
                startSessionTimer();

                // Show mapping card
                renderColumnMapping();
                document.getElementById('mappingCard').style.display = 'block';

            } catch (error) {
                console.error('Upload error:', error);
                alert(`Fehler beim Hochladen: ${error.message}`);
            }
        }

        function renderColumnMapping() {
            const checker = state.selectedChecker;
            const mappingGrid = document.getElementById('mappingGrid');

            // Define fields to map based on checker
            const fields = [
                { id: 'plz', label: 'PLZ', required: checker?.required_columns?.includes('plz') },
                { id: 'ort', label: 'Ort', required: checker?.required_columns?.includes('ort') },
                { id: 'strasse', label: 'Strasse', required: checker?.required_columns?.includes('strasse') },
                { id: 'kanton', label: 'Kanton', required: false },
                { id: 'egid', label: 'EGID', required: checker?.required_columns?.includes('egid') },
                { id: 'easting', label: 'E-Koordinate', required: checker?.required_columns?.includes('easting') },
                { id: 'northing', label: 'N-Koordinate', required: checker?.required_columns?.includes('northing') },
            ];

            mappingGrid.innerHTML = fields.map(field => `
                <div class="form-group">
                    <label>${field.label}${field.required ? ' *' : ''}</label>
                    <select id="col_${field.id}">
                        <option value="">-- Nicht zugeordnet --</option>
                        ${state.columns.map(col => `
                            <option value="${col.name}" ${state.detectedMappings[field.id] === col.name ? 'selected' : ''}>
                                ${col.name}${col.detected_as ? ` (${col.detected_as})` : ''}
                            </option>
                        `).join('')}
                    </select>
                </div>
            `).join('');

            // Populate dimension dropdowns
            ['dimRegion', 'dimPortfolio', 'dimResponsible'].forEach(dimId => {
                const select = document.getElementById(dimId);
                select.innerHTML = `
                    <option value="">-- Nicht verwenden --</option>
                    ${state.columns.map(col => `
                        <option value="${col.name}">${col.name}</option>
                    `).join('')}
                `;
            });

            // Auto-select likely dimension columns
            state.columns.forEach(col => {
                const name = col.name.toLowerCase();
                if (name.includes('kanton') || name.includes('region')) {
                    document.getElementById('dimRegion').value = col.name;
                }
                if (name.includes('portfolio') || name.includes('typ') || name.includes('kategorie')) {
                    document.getElementById('dimPortfolio').value = col.name;
                }
                if (name.includes('verantwort') || name.includes('zust√§ndig') || name.includes('bearbeiter')) {
                    document.getElementById('dimResponsible').value = col.name;
                }
            });
        }

        // ====================================================================
        // Validation
        // ====================================================================

        async function runValidation() {
            if (!state.sessionId) {
                alert('Bitte laden Sie zuerst eine Datei hoch.');
                return;
            }

            document.getElementById('mappingCard').style.display = 'none';
            document.getElementById('loadingCard').style.display = 'block';

            // Gather column mappings
            const columns = {};
            ['plz', 'ort', 'strasse', 'kanton', 'egid', 'easting', 'northing'].forEach(field => {
                const select = document.getElementById(`col_${field}`);
                if (select && select.value) {
                    columns[field] = select.value;
                }
            });

            const dimensionColumns = {
                region: document.getElementById('dimRegion').value,
                portfolio: document.getElementById('dimPortfolio').value,
                responsible: document.getElementById('dimResponsible').value,
            };

            const config = {
                columns: columns,
                options: {},
                rule_ids: state.selectedChecker?.rule_ids || null,
                dimension_columns: dimensionColumns,
            };

            try {
                const response = await fetch(`${API_URL}/api/validate/${state.sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Validation failed');
                }

                state.results = await response.json();
                renderResults();
                showView('results');

            } catch (error) {
                console.error('Validation error:', error);
                alert(`Fehler bei der Validierung: ${error.message}`);
                document.getElementById('mappingCard').style.display = 'block';
            } finally {
                document.getElementById('loadingCard').style.display = 'none';
            }
        }

        // ====================================================================
        // Results Rendering
        // ====================================================================

        function renderResults() {
            const r = state.results;

            // Stats
            document.getElementById('statTotal').textContent = r.total_rows;
            document.getElementById('statErrors').textContent = r.error_count;
            document.getElementById('statWarnings').textContent = r.warning_count;
            document.getElementById('statPassed').textContent = r.passed_rows;

            // Category breakdown
            const categoryGrid = document.getElementById('categoryGrid');
            const categories = r.errors_by_category || {};
            if (Object.keys(categories).length > 0) {
                categoryGrid.innerHTML = Object.entries(categories).map(([cat, count]) => `
                    <div class="dimension-card">
                        <h4>${cat.charAt(0).toUpperCase() + cat.slice(1)}</h4>
                        <div class="errors">
                            <span class="error-badge">üî¥ ${count} Fehler</span>
                        </div>
                    </div>
                `).join('');
            } else {
                categoryGrid.innerHTML = '<p style="color: var(--success);">‚úì Keine Fehler gefunden!</p>';
            }

            // Top issues
            const topIssues = document.getElementById('topIssues');
            const ruleErrors = r.errors_by_rule || {};
            const sortedRules = Object.entries(ruleErrors).sort((a, b) => b[1] - a[1]).slice(0, 5);
            if (sortedRules.length > 0) {
                topIssues.innerHTML = `
                    <ol style="margin-left: 1.5rem;">
                        ${sortedRules.map(([rule, count]) => `
                            <li style="margin-bottom: 0.5rem;">${rule}: <strong>${count}</strong></li>
                        `).join('')}
                    </ol>
                `;
            } else {
                topIssues.innerHTML = '<p style="color: var(--success);">‚úì Keine Probleme gefunden!</p>';
            }

            // Dimension grids
            renderDimensionGrid('regionGrid', r.by_region);
            renderDimensionGrid('portfolioGrid', r.by_portfolio);
            renderDimensionGrid('responsibleGrid', r.by_responsible);

            // Error table
            const errorTableBody = document.getElementById('errorTableBody');
            errorTableBody.innerHTML = r.errors.slice(0, 100).map(err => `
                <tr>
                    <td>${err.row_number}</td>
                    <td>${err.column}</td>
                    <td>${err.rule_name}</td>
                    <td><span class="severity-badge ${err.severity}">${err.severity}</span></td>
                    <td>${err.message}</td>
                </tr>
            `).join('');

            if (r.errors.length > 100) {
                errorTableBody.innerHTML += `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                            ... und ${r.errors.length - 100} weitere Fehler (Download f√ºr vollst√§ndige Liste)
                        </td>
                    </tr>
                `;
            }
        }

        function renderDimensionGrid(gridId, data) {
            const grid = document.getElementById(gridId);
            if (!data || Object.keys(data).length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary);">Keine Daten f√ºr diese Dimension</p>';
                return;
            }

            grid.innerHTML = Object.entries(data).map(([name, stats]) => {
                const passRate = stats.total > 0 ? ((stats.total - stats.errors) / stats.total * 100) : 100;
                return `
                    <div class="dimension-card">
                        <h4>${name}</h4>
                        <div class="count">${stats.total} Objekte</div>
                        <div class="errors">
                            <span class="error-badge">üî¥ ${stats.errors}</span>
                            <span class="warning-badge">üü° ${stats.warnings}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="fill" style="width: ${passRate}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ====================================================================
        // Download
        // ====================================================================

        async function downloadReport() {
            if (!state.sessionId) return;

            try {
                const response = await fetch(`${API_URL}/api/session/${state.sessionId}/download/report`);
                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'validierung_fehler.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Download error:', error);
                alert('Fehler beim Download');
            }
        }

        // ====================================================================
        // Navigation
        // ====================================================================

        function selectChecker(checkerId) {
            fetch(`${API_URL}/api/checkers/${checkerId}`)
                .then(r => r.json())
                .then(checker => {
                    state.selectedChecker = checker;
                    document.getElementById('selectedCategory').textContent = checker.category;
                    document.getElementById('selectedCheckerName').textContent = checker.name;
                    document.getElementById('selectedCheckerDesc').textContent = checker.description_long || checker.description;
                    showView('upload');
                })
                .catch(err => console.error('Error:', err));
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}View`).classList.add('active');

            // Reset upload view if returning to gallery
            if (viewName === 'gallery') {
                state.sessionId = null;
                state.selectedChecker = null;
                state.results = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('mappingCard').style.display = 'none';
                document.getElementById('sessionTimer').style.display = 'none';
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = content.id === `tab-${tabName}` ? 'block' : 'none';
            });
        }

        // ====================================================================
        // Session Timer
        // ====================================================================

        function startSessionTimer() {
            document.getElementById('sessionTimer').style.display = 'flex';

            const updateTimer = () => {
                if (!state.sessionExpiry) return;

                const remaining = Math.max(0, state.sessionExpiry - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('timerDisplay').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    alert('Session abgelaufen. Bitte laden Sie die Datei erneut hoch.');
                    showView('gallery');
                }
            };

            updateTimer();
            setInterval(updateTimer, 1000);
        }
    </script>
</body>
</html>
